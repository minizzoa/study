<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Îã¨Í≥†ÎÇò ÌÉÄÏûÑ Ïñ¥ÌÉù - ÏµúÏ¢Ö ÏóêÎîîÏÖò</title>
    <style>
        :root { 
            --bg: #fdf5e6; --dalgona: #d2a679; --accent: #d32f2f; 
            --glass: rgba(255, 255, 255, 0.85);
        }
        body { 
            text-align: center; background-color: var(--bg); font-family: 'Pretendard', sans-serif; 
            margin: 0; padding: 5px; height: 100vh; display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        
        h1 { font-size: 22px; color: #5d4037; margin: 10px 0; font-weight: 900; }
        
        #control-bar { width: 95%; max-width: 420px; display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 5px; }
        .icon-btn {
            background: var(--glass); border: 1px solid #d2a679; border-radius: 50%; 
            width: 38px; height: 38px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 18px;
        }

        #header { width: 95%; max-width: 420px; display: flex; justify-content: space-between; gap: 8px; margin-bottom: 10px; }
        .stat-box { background: var(--glass); padding: 8px 5px; border-radius: 12px; flex: 1; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .label { font-size: 11px; color: #8d6e63; display: block; font-weight: bold; }
        .value { font-size: 20px; font-weight: 900; color: #3e2723; }

        #game-container { position: relative; touch-action: none; margin-bottom: 15px; }
        canvas#gameCanvas { 
            background: var(--dalgona); border-radius: 50%; box-shadow: 0 8px 20px rgba(0,0,0,0.25); 
            border: 8px solid #c49668; cursor: none; width: 85vw; height: 85vw; max-width: 360px; max-height: 360px;
        }

        #feedback-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; font-weight: 900; pointer-events: none; z-index: 40;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.2s;
        }

        #finger-img { position: absolute; width: 32px; height: 50px; pointer-events: none; z-index: 50; display: none; }
        
        /* Ïò§Î≤ÑÎ†àÏù¥ Í≥µÌÜµ */
        #pause-overlay, #clear-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 60;
            overflow: hidden;
        }
        #pause-overlay { background: rgba(0, 0, 0, 0.6); color: white; }
        #clear-overlay { background: rgba(0, 0, 0, 0.92); color: white; }

        /* Ìè≠Ï£Ω Ï∫îÎ≤ÑÏä§ - ÌÅ¥Î¶¨Ïñ¥ Ïò§Î≤ÑÎ†àÏù¥ ÎÇ¥Î∂ÄÏóê ÏúÑÏπò */
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        #record-board { 
            width: 90%; max-width: 360px; background: rgba(93, 64, 55, 0.12); 
            border-radius: 15px; padding: 12px; border: 1.5px solid rgba(210, 166, 121, 0.4);
        }
        #best-total { font-size: 24px; font-weight: 900; color: var(--accent); display: block; margin-top: 5px; }

        button.main-btn { position: relative; z-index: 70; padding: 12px 35px; background: #4caf50; color: white; border: none; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <h1>‚ú® Îã¨Í≥†ÎÇò ÌÉÄÏûÑ Ïñ¥ÌÉù ‚ú®</h1>

    <div id="control-bar">
        <button id="pause-btn" class="icon-btn" onclick="togglePause()">‚è∏</button>
        <button id="mute-btn" class="icon-btn" onclick="toggleMute()">üîä</button>
    </div>

    <div id="header">
        <div class="stat-box"><span class="label">STAGE</span><span class="value" id="stageName">1 / 5</span></div>
        <div class="stat-box"><span class="label">PROGRESS</span><span class="value" id="progress">0</span>%</div>
        <div class="stat-box"><span class="label">TIME</span><span class="value" id="timer">0.00</span>s</div>
    </div>

    <div id="game-container">
        <div id="feedback-text"></div>
        <img id="finger-img" src="finger.png" alt="finger">
        
        <div id="pause-overlay">
            <h2 style="font-size: 28px; margin-bottom: 20px;">Ïû†Ïãú Î©àÏ∂§</h2>
            <button class="main-btn" onclick="togglePause()">RESUME</button>
        </div>

        <div id="clear-overlay">
            <canvas id="confetti-canvas"></canvas>
            <div style="position: relative; z-index: 70;">
                <h2 style="color: gold; margin:0; font-size: 24px;">MISSION COMPLETE!</h2>
                <h1 id="finalTime" style="font-size: 48px; margin: 10px 0;">0.00s</h1>
                <p id="newRecordMsg" style="color: #ffeb3b; font-weight: bold; font-size: 18px; margin-bottom: 15px;"></p>
                <button class="main-btn" onclick="location.reload()">TRY AGAIN</button>
            </div>
        </div>

        <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>

    <div id="record-board">
        <span style="font-size: 15px; font-weight: bold; color: #5d4037;">üèÜ BEST RECORD</span>
        <span id="best-total">--.-- s</span>
    </div>

<script>
// ÏÇ¨Ïö¥Îìú ÏÑ§Ï†ï
const sndCorrect = new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3');
const sndWrong = new Audio('https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3');
const sndTick = new Audio('https://assets.mixkit.co/active_storage/sfx/2544/2544-preview.mp3'); 
const sndSuccess = new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'); 

let gameActive = true, isDrawing = false, gameStartTime = null, isMuted = false, isPaused = false;
let pausedTime = 0, pauseStartTime = 0;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const fingerImg = document.getElementById('finger-img');
const feedbackText = document.getElementById('feedback-text');
const confettiCanvas = document.getElementById('confetti-canvas');
const confCtx = confettiCanvas.getContext('2d');

let points = [], visited = [], drawPath = [], particles = [];
let currentStageCount = 1; const maxStages = 5;

const shapes = [
    { name: "ÏÑ∏Î™®", type: "poly", sides: 3, r: 130 },
    { name: "ÎÑ§Î™®", type: "poly", sides: 4, r: 130 },
    { name: "Î≥Ñ", type: "star", rOut: 140, rIn: 65 },
    { name: "ÌïòÌä∏", type: "heart", r: 9 },
    { name: "Î∞òÏõê", type: "halfCircle", r: 130 }
];

function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('mute-btn').innerText = isMuted ? "üîá" : "üîä";
}

function togglePause() {
    if (!gameActive) return;
    isPaused = !isPaused;
    document.getElementById('pause-overlay').style.display = isPaused ? 'flex' : 'none';
    document.getElementById('pause-btn').innerText = isPaused ? "‚ñ∂" : "‚è∏";
    if (isPaused) { pauseStartTime = Date.now(); }
    else { if (gameStartTime) pausedTime += (Date.now() - pauseStartTime); }
}

function playSound(snd) {
    if (isMuted) return;
    snd.currentTime = 0;
    snd.play().catch(() => {});
}

function createShape() {
    points = []; drawPath = [];
    const cx = 200, cy = 200;
    const s = shapes[Math.floor(Math.random() * shapes.length)];
    document.getElementById('stageName').innerText = `${currentStageCount} / ${maxStages}`;
    
    const addP = (x, y) => {
        if (points.length > 0) {
            let last = points[points.length-1];
            let d = Math.sqrt((x-last.x)**2 + (y-last.y)**2);
            for(let i=1; i<d; i+=3) points.push({x: last.x + (x-last.x)*(i/d), y: last.y + (y-last.y)*(i/d)});
        }
        points.push({x, y});
    };

    if (s.type === "poly") { for (let i=0; i<=s.sides; i++) { let a = (Math.PI*2/s.sides)*i - Math.PI/2; addP(cx+Math.cos(a)*s.r, cy+Math.sin(a)*s.r); } }
    else if (s.type === "star") { for (let i=0; i<=10; i++) { let a = (Math.PI/5)*i - Math.PI/2; let r = (i%2===0) ? s.rOut : s.rIn; addP(cx+Math.cos(a)*r, cy+Math.sin(a)*r); } }
    else if (s.type === "heart") { for (let t=0; t<=Math.PI*2.01; t+=0.05) points.push({x: cx + 16*Math.sin(t)**3*s.r, y: cy - (13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t))*s.r}); }
    else if (s.type === "halfCircle") { for (let a=Math.PI; a<=Math.PI*2.01; a+=0.05) points.push({x: cx+Math.cos(a)*s.r, y: cy+Math.sin(a)*s.r}); addP(cx-s.r, cy); addP(cx+s.r, cy); }
    visited = new Array(points.length).fill(false);
}

function handleInput(e) {
    if (!gameActive || isPaused) return;
    const rect = canvas.getBoundingClientRect();
    const sc = 400 / rect.width;
    const ev = e.touches ? e.touches[0] : e;
    const clientX = ev.clientX - rect.left;
    const clientY = ev.clientY - rect.top;

    fingerImg.style.display = "block";
    fingerImg.style.left = clientX + "px";
    fingerImg.style.top = clientY + "px";

    if (!isDrawing) return;
    if (!gameStartTime) gameStartTime = Date.now();
    
    feedbackText.style.opacity = 0; 
    const x = clientX * sc, y = clientY * sc;
    drawPath.push({x, y}); render();
    points.forEach((p, i) => { if (Math.sqrt((p.x-x)**2+(p.y-y)**2) < 20) visited[i] = true; });
    let pgr = Math.min(100, Math.round((visited.filter(v=>v).length/points.length)*100));
    document.getElementById('progress').innerText = pgr;
    if (pgr >= 99) complete();
}

function showFeedback(msg, isSuccess) {
    feedbackText.innerText = msg;
    feedbackText.style.color = isSuccess ? "#2e7d32" : "#d32f2f";
    feedbackText.style.opacity = 1;
    setTimeout(() => { feedbackText.style.opacity = 0; }, 600);
}

function complete() {
    isDrawing = false;
    showFeedback("GOOD!", true);
    if (currentStageCount < maxStages) {
        currentStageCount++;
        playSound(sndCorrect);
        setTimeout(() => { 
            createShape(); drawPath = []; 
            document.getElementById('progress').innerText = "0"; 
            render(); 
        }, 700);
    } else { showClear(); }
}

function handleEnd() {
    if (!gameActive || !isDrawing || isPaused) return;
    isDrawing = false;
    if (parseInt(document.getElementById('progress').innerText) < 99) {
        playSound(sndWrong);
        showFeedback("FAIL", false);
        visited.fill(false); drawPath = []; render();
    }
}

function showClear() {
    gameActive = false; 
    playSound(sndSuccess);
    const totalTime = parseFloat(document.getElementById('timer').innerText);
    document.getElementById('finalTime').innerText = totalTime.toFixed(2) + "s";
    
    let oldBest = localStorage.getItem('dalgonaBestTime');
    if (!oldBest || totalTime < parseFloat(oldBest)) {
        localStorage.setItem('dalgonaBestTime', totalTime);
        document.getElementById('newRecordMsg').innerText = "üéä ÏµúÍ≥† Í∏∞Î°ù Îã¨ÏÑ±! üéä";
        document.getElementById('best-total').innerText = totalTime.toFixed(2) + " s";
    }
    
    document.getElementById('clear-overlay').style.display = 'flex';
    setTimeout(createConfetti, 100); // Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú ÌõÑ ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ ÏÉùÏÑ±
}

function createConfetti() {
    confettiCanvas.width = confettiCanvas.offsetWidth;
    confettiCanvas.height = confettiCanvas.offsetHeight;
    particles = [];
    const centerX = confettiCanvas.width / 2;
    const centerY = confettiCanvas.height / 2;

    for(let i=0; i<150; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 12 + 4;
        particles.push({
            x: centerX, y: centerY, 
            color: `hsl(${Math.random()*360}, 100%, 60%)`,
            v: { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed },
            r: Math.random() * 5 + 2,
            friction: 0.97,
            gravity: 0.25
        });
    }
    animateConfetti();
}

function animateConfetti() {
    if (gameActive) return;
    confCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    particles.forEach(p => {
        p.v.x *= p.friction; p.v.y *= p.friction;
        p.v.y += p.gravity;
        p.x += p.v.x; p.y += p.v.y;
        confCtx.fillStyle = p.color;
        confCtx.beginPath(); confCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); confCtx.fill();
    });
    requestAnimationFrame(animateConfetti);
}

function render() {
    ctx.clearRect(0,0,400,400);
    ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y);
    points.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.strokeStyle = "rgba(0,0,0,0.15)"; ctx.lineWidth = 15; ctx.lineCap = "round"; ctx.stroke();
    if (drawPath.length > 0) {
        ctx.beginPath(); ctx.moveTo(drawPath[0].x, drawPath[0].y);
        for(let i=1; i<drawPath.length; i++) ctx.lineTo(drawPath[i].x, drawPath[i].y);
        ctx.strokeStyle = "white"; ctx.lineWidth = 6; ctx.lineCap = "round"; ctx.lineJoin = "round"; ctx.stroke();
    }
}

canvas.addEventListener('mousedown', () => { if(!isPaused) isDrawing = true; });
canvas.addEventListener('touchstart', (e) => { if(!isPaused) { isDrawing = true; handleInput(e); e.preventDefault(); } }, {passive: false});
window.addEventListener('mousemove', handleInput);
window.addEventListener('touchmove', handleInput, {passive: false});
window.addEventListener('mouseup', handleEnd);
window.addEventListener('touchend', handleEnd);

setInterval(() => { 
    if (gameActive && gameStartTime && !isPaused) {
        let now = Date.now();
        document.getElementById('timer').innerText = ((now - gameStartTime - pausedTime) / 1000).toFixed(2);
    }
}, 30);

const savedBest = localStorage.getItem('dalgonaBestTime');
if (savedBest) document.getElementById('best-total').innerText = parseFloat(savedBest).toFixed(2) + " s";

createShape(); render();
</script>
</body>
</html>
