<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¤ì´ë‚˜ë¯¹ í…ŒíŠ¸ë¦¬ìŠ¤</title>
    <style>
        :root { --bg-color: #1a1a2e; --panel-color: #16213e; --accent-color: #e94560; --width-ref: 300px; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-color); color: white; font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden;
        }

        h1 { margin: 15px 0 10px; font-size: 22px; color: #00d2ff; letter-spacing: 1px; }

        /* ìƒë‹¨ UI íŒ¨ë„: ê¸°ì¤€ ë„ˆë¹„ 300px */
        .ui-panel { width: var(--width-ref); margin-bottom: 10px; padding: 0 5px; }
        .score-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .score-box { font-size: 18px; font-weight: bold; }
        .high-score { font-size: 13px; color: #ffd700; margin-top: 4px; border-top: 1px solid #333; padding-top: 4px; }

        /* ê²Œì„ ë³´ë“œ: ê°€ë¡œ 300px ê³ ì •, ì„¸ë¡œ ë¹„ìœ¨ 1.5 (450px) */
        .game-container { 
            position: relative; 
            border: 4px solid #333; 
            background: #000; 
            width: var(--width-ref); 
            height: 450px; 
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            border-radius: 4px;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ëŸ¬: ìƒë‹¨ê³¼ ë™ì¼í•œ ë„ˆë¹„ 300pxë¡œ ì •ë ¬ */
        .bottom-controls {
            width: var(--width-ref);
            margin-top: 20px;
            display: flex; flex-direction: column; align-items: center;
            padding-bottom: 30px;
        }

        .controls-row { 
            display: flex; justify-content: space-between; gap: 6px; width: 100%;
        }
        
        .controls-row button { 
            flex: 1; background: #252a41; color: white; border: 2px solid #444; 
            border-radius: 12px; padding: 18px 0; font-size: 20px; 
            cursor: pointer; transition: background 0.1s, transform 0.1s; 
        }
        
        .controls-row button:active { background: var(--accent-color); transform: scale(0.92); }
        .btn-drop { background: #4ecca3 !important; border-color: #3cb371 !important; }

        .util-row { margin-top: 15px; display: flex; gap: 10px; width: 100%; }
        .btn-util { flex: 1; background: #333; color: white; border: none; border-radius: 8px; padding: 10px; font-size: 13px; cursor: pointer; }

        /* ì˜¤ë²„ë ˆì´ */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 10; text-align: center; 
        }
        .btn-start { background: var(--accent-color); padding: 14px 35px; font-size: 18px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px #a02d41; }
        .btn-start:active { transform: translateY(2px); box-shadow: 0 2px #a02d41; }

        /* ì†Œí˜• í™”ë©´ ëŒ€ì‘ */
        @media (max-height: 700px) {
            h1 { margin: 5px 0; font-size: 18px; }
            .game-container { height: 360px; width: 240px; }
            .ui-panel, .bottom-controls { width: 240px; }
            .controls-row button { padding: 12px 0; font-size: 18px; }
        }
    </style>
</head>
<body>

    <h1>ë‹¤ì´ë‚˜ë¯¹ í…ŒíŠ¸ë¦¬ìŠ¤</h1>

    <div class="ui-panel">
        <div class="score-row">
            <div class="score-box">SCORE: <span id="score">0</span> <span style="font-size:12px; color:#aaa; font-weight:normal;">LV.<span id="level">1</span></span></div>
            <button id="muteBtn" class="btn-util" style="flex:none; width:70px;">ğŸ”Š ON</button>
        </div>
        <div class="high-score">ğŸ† BEST: <span id="highScore">0</span></div>
    </div>

    <div class="game-container">
        <canvas id="tetris" width="300" height="450"></canvas>
        <div id="startOverlay" class="overlay">
            <div id="gameOverMsg" style="display:none; color:#ff4d4d; font-size:24px; font-weight:bold; margin-bottom:15px;">GAME OVER</div>
            <button class="btn-start" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>
        <div id="pauseOverlay" class="overlay" style="display:none;">
            <h2 style="color:var(--accent-color); margin-bottom:20px;">ì¼ì‹œ ì •ì§€</h2>
            <button class="btn-start" onclick="togglePause()">ê³„ì†í•˜ê¸°</button>
        </div>
    </div>

    <div class="bottom-controls">
        <div class="controls-row">
            <button onclick="handleControl('left')">â—€</button>
            <button onclick="handleControl('up')">ğŸ”„</button>
            <button onclick="handleControl('down')">â–¼</button>
            <button onclick="handleControl('right')">â–¶</button>
            <button class="btn-drop" onclick="handleControl('drop')">â¤“</button>
        </div>
        <div class="util-row">
            <button class="btn-util" onclick="togglePause()">PAUSE / PLAY</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('tetris');
        const ctx = canvas.getContext('2d');
        const ROWS = 18; 
        const COLS = 12; 
        const SQ = 25; 
        
        const SHAPES = {
            'I': [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],
            'L': [[0,2,0],[0,2,0],[0,2,2]],
            'J': [[0,3,0],[0,3,0],[3,3,0]],
            'O': [[4,4],[4,4]],
            'Z': [[5,5,0],[0,5,5],[0,0,0]],
            'S': [[0,6,6],[6,6,0],[0,0,0]],
            'T': [[0,7,0],[7,7,7],[0,0,0]]
        };
        const COLORS = [null, '#00f0f0', '#f0a000', '#0000f0', '#f0f000', '#f00000', '#00f000', '#a000f0'];

        let board, player, score, level, isPaused, isMuted = false, gameRunning = false;
        let dropInterval = 1000, dropCounter = 0, lastTime = 0;
        let audioCtx, highScore = localStorage.getItem('tetrisScoreRefined') || 0;

        document.getElementById('highScore').innerText = highScore;

        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

        function playSound(freq, type = 'sine', duration = 0.1) {
            if (isMuted || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function initGame() {
            board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
            score = 0; level = 1; dropInterval = 1000; isPaused = false;
            updateUI(); spawnPlayer();
        }

        function updateUI() {
            document.getElementById('score').innerText = score;
            document.getElementById('level').innerText = level;
            document.getElementById('highScore').innerText = highScore;
        }

        function spawnPlayer() {
            const types = 'IJLOSTZ';
            const type = types[Math.floor(Math.random() * types.length)];
            player = { pos: {x: Math.floor(COLS/2)-1, y: 0}, matrix: SHAPES[type], colorIndex: Object.keys(SHAPES).indexOf(type)+1 };
            if (collide(board, player)) gameOver();
        }

        function gameOver() {
            gameRunning = false;
            playSound(100, 'sawtooth', 0.5);
            if (score > highScore) { highScore = score; localStorage.setItem('tetrisScoreRefined', highScore); }
            document.getElementById('gameOverMsg').style.display = 'block';
            document.getElementById('startOverlay').style.display = 'flex';
            updateUI();
        }

        function rotate(matrix) { return matrix[0].map((_, i) => matrix.map(row => row[i]).reverse()); }

        function collide(board, player) {
            const [m, o] = [player.matrix, player.pos];
            for (let y = 0; y < m.length; ++y) {
                for (let x = 0; x < m[y].length; ++x) {
                    if (m[y][x] !== 0 && (board[y+o.y] && board[y+o.y][x+o.x]) !== 0) return true;
                }
            }
            return false;
        }

        function handleControl(dir) {
            if (!gameRunning || isPaused) return;
            if (dir === 'left') { player.pos.x--; if(collide(board, player)) player.pos.x++; }
            if (dir === 'right') { player.pos.x++; if(collide(board, player)) player.pos.x--; }
            if (dir === 'down') { player.pos.y++; if(collide(board, player)) { player.pos.y--; dropComplete(); } }
            if (dir === 'drop') { while(!collide(board, player)) { player.pos.y++; } player.pos.y--; dropComplete(); playSound(200, 'sine', 0.05); }
            if (dir === 'up') { 
                const old = player.matrix; player.matrix = rotate(player.matrix);
                if(collide(board, player)) player.matrix = old; else playSound(500, 'sine', 0.05);
            }
            draw();
        }

        function dropComplete() { merge(); lineClear(); if (gameRunning) spawnPlayer(); dropCounter = 0; }

        function merge() {
            player.matrix.forEach((row, y) => { row.forEach((v, x) => { if (v) board[y+player.pos.y][x+player.pos.x] = player.colorIndex; }); });
            playSound(300, 'sine', 0.05);
        }

        function lineClear() {
            let lines = 0;
            for (let y = ROWS-1; y >= 0; y--) {
                if (board[y].every(v => v > 0)) { board.splice(y, 1); board.unshift(Array(COLS).fill(0)); lines++; y++; }
            }
            if (lines > 0) {
                score += [0, 100, 300, 500, 800][lines];
                let newLevel = Math.floor(score/600)+1;
                if (newLevel > level) { level = newLevel; dropInterval = Math.max(120, 1000*Math.pow(0.82, level-1)); }
                updateUI(); playSound(800, 'square', 0.15);
            }
        }

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            board.forEach((row, y) => row.forEach((v, x) => { if(v) drawRect(x, y, COLORS[v]); }));
            if (gameRunning) { player.matrix.forEach((row, y) => row.forEach((v, x) => { if(v) drawRect(player.pos.x+x, player.pos.y+y, COLORS[player.colorIndex]); })); }
        }

        function drawRect(x, y, color) {
            ctx.fillStyle = color; ctx.fillRect(x*SQ, y*SQ, SQ-1, SQ-1);
            // ë¸”ë¡ ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸ (ì…ì²´ê°)
            ctx.fillStyle = 'rgba(255,255,255,0.15)'; ctx.fillRect(x*SQ, y*SQ, SQ-1, 3);
            ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(x*SQ, y*SQ + SQ-4, SQ-1, 3);
        }

        function update(time = 0) {
            if (!isPaused && gameRunning) {
                const deltaTime = time - lastTime; lastTime = time; dropCounter += deltaTime;
                if (dropCounter > dropInterval) { handleControl('down'); dropCounter = 0; }
                draw();
            } else { lastTime = time; }
            requestAnimationFrame(update);
        }

        function startGame() { 
            initAudio(); 
            document.getElementById('gameOverMsg').style.display='none'; 
            initGame(); gameRunning=true; 
            document.getElementById('startOverlay').style.display='none'; 
        }
        function togglePause() { if (!gameRunning) return; isPaused = !isPaused; document.getElementById('pauseOverlay').style.display = isPaused ? 'flex' : 'none'; }
        document.getElementById('muteBtn').onclick = () => { isMuted = !isMuted; document.getElementById('muteBtn').innerText = isMuted ? 'ğŸ”‡ OFF' : 'ğŸ”Š ON'; };

        document.addEventListener('keydown', e => {
            if(e.code === 'ArrowLeft') handleControl('left'); if(e.code === 'ArrowRight') handleControl('right');
            if(e.code === 'ArrowDown') handleControl('down'); if(e.code === 'ArrowUp') handleControl('up');
            if(e.code === 'Space') handleControl('drop');
        });

        update();
    </script>
</body>
</html>