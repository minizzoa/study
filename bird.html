<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ¤ ë‚ ì•„ë¼ ì‚ì•½ì´! âœ¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky: #87CEEB;
            --btn-main: #ff8b94;
        }
        body { 
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; 
            background: #fdf6e3; font-family: 'Jua', sans-serif; overflow: hidden;
            touch-action: none; -webkit-user-select: none; user-select: none;
        }

        h1 { margin: 10px 0 5px 0; color: #ff8b94; font-size: 1.8rem; }

        .status-bar {
            width: 95vw; max-width: 380px; display: flex; flex-direction: column; 
            gap: 5px; margin-bottom: 10px; background: white; 
            padding: 8px 12px; border-radius: 12px; box-sizing: border-box; box-shadow: 0 4px #eee;
        }
        .info-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .score-info { font-size: 1.1rem; color: #5d544b; display: flex; align-items: center; gap: 8px; }
        .high-score-info { font-size: 0.9rem; color: #ff7b25; }
        #level-tag { font-size: 0.8rem; background: #ffeb3b; padding: 2px 8px; border-radius: 10px; }

        .controls { display: flex; gap: 5px; }
        
        /* ë²„íŠ¼ ì„¸ë¡œ ê¸¸ì´ ì¶•ì†Œ (padding ìˆ˜ì •) */
        button {
            padding: 4px 10px; border: none; border-radius: 6px; font-family: 'Jua';
            font-size: 0.85rem; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center;
        }
        .btn-pause { background: #feb236; }
        .btn-restart { background: #ff7b25; }
        .btn-mute { background: #a8a8a8; width: 35px; font-size: 1rem; }
        .btn-mute.active { background: #ff8b94; }

        #game-container { position: relative; width: 90vw; height: 60vh; max-width: 360px; max-height: 480px; }
        canvas { 
            background: var(--sky); border-radius: 15px; width: 100%; height: 100%;
            display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: background 1.5s;
        }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            border-radius: 15px; z-index: 10; text-align: center;
        }
        
        .guide-text { margin-top: 10px; color: #888; font-size: 0.85rem; text-align: center; }
    </style>
</head>
<body>

    <h1>ğŸ¤ ë‚ ì•„ë¼ ì‚ì•½ì´! ğŸš€</h1>

    <div class="status-bar">
        <div class="info-row">
            <div class="score-info">
                <span>ì ìˆ˜: <b id="score">0</b></span>
                <span id="level-tag">ì´ˆë³´ ì‚ì•½ì´</span>
            </div>
            <div class="high-score-info">ğŸ† ìµœê³ : <span id="best">0</span></div>
        </div>
        <div class="info-row" style="margin-top: 3px;">
            <div style="color: #aaa; font-size: 0.75rem;">ì—´ì‹¬íˆ ë‚ ì•„ë´ìš”!</div>
            <div class="controls">
                <button class="btn-mute" id="muteBtn" onclick="toggleMute(event)">ğŸ”Š</button>
                <button class="btn-pause" onclick="togglePause(event)" id="pauseBtn">ì¤‘ì§€</button>
                <button class="btn-restart" onclick="resetGame(event)">ë‹¤ì‹œ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="overlay">
            <h2 id="end-title" style="font-size: 1.8rem; color: #ff8b94; margin: 0;">ì‚ì•½... í„¸ì©!</h2>
            <p id="finalScore" style="font-size: 1.1rem; margin: 5px 0;"></p>
            <p id="bestNotice" style="font-size: 0.9rem; color: #ff7b25; margin-bottom: 12px; font-weight: bold;"></p>
            <button class="btn-restart" onclick="resetGame(event)" style="padding: 8px 20px; font-size: 1.1rem; background: var(--btn-main); width: auto;">ë‹¤ì‹œ ë„ì „!</button>
        </div>
    </div>
    
    <p class="guide-text">í™”ë©´ì„ í„°ì¹˜í•´ì„œ ì‚ì•½ì´ë¥¼ ë†’ì´ ë„ìš°ì„¸ìš”!</p>

    <img src="chick_flying.png" id="birdImage" style="display:none;" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; window.imageError=true;">

    <audio id="jumpSound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" preload="auto"></audio>
    <audio id="scoreSound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
    <audio id="hitSound" src="https://assets.mixkit.co/active_storage/sfx/2533/2533-preview.mp3" preload="auto"></audio>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const pauseBtn = document.getElementById("pauseBtn");
        const muteBtn = document.getElementById("muteBtn");
        const overlay = document.getElementById("overlay");
        const levelTag = document.getElementById("level-tag");
        const birdImage = document.getElementById("birdImage");
        const bestEl = document.getElementById("best");
        
        const CW = 360, CH = 500;
        canvas.width = CW; canvas.height = CH;

        let bird, pipes, score, frames, gameActive = false, isPaused = false, isMuted = false;
        let highScore = localStorage.getItem("piyakHighScore") || 0;
        bestEl.innerText = highScore;

        let pipeSpeed, pipeGap, spawnInterval;

        // í•µì‹¬ ìˆ˜ì •: ì´ë¯¸ì§€ ë¡œë”©ê³¼ ìƒê´€ì—†ì´ ê²Œì„ ì‹¤í–‰ ë³´ì¥
        function startGameSafely() {
            if (!gameActive && frames === undefined) {
                resetGame();
            }
        }

        birdImage.onload = startGameSafely;
        // 1ì´ˆ ë’¤ì—ë„ ê²Œì„ì´ ì•ˆ ëœ¨ë©´ ê°•ì œ ì‹¤í–‰ (ì´ë¯¸ì§€ ê²½ë¡œ ì˜¤ë¥˜ ëŒ€ë¹„)
        setTimeout(startGameSafely, 1000);

        function playSfx(id) {
            if (isMuted) return;
            const sound = document.getElementById(id);
            sound.currentTime = 0;
            sound.play().catch(() => {});
        }

        function toggleMute(e) {
            e.stopPropagation();
            isMuted = !isMuted;
            muteBtn.innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
            muteBtn.classList.toggle('active', isMuted);
        }

        class Bird {
            constructor() {
                this.x = 60; this.y = CH / 2; this.v = 0;
                this.gravity = 0.22; this.jumpPower = -4.8; 
                this.width = 36; this.height = 36;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Math.min(Math.PI / 4, Math.max(-Math.PI / 4, this.v * 0.1)));
                
                // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ ì—¬ë¶€ í™•ì¸
                if (birdImage.complete && birdImage.naturalWidth > 1) {
                    ctx.drawImage(birdImage, -this.width / 2, -this.height / 2, this.width, this.height);
                } else {
                    // ì´ë¯¸ì§€ ì—†ì„ ë•Œ ë…¸ë€ ë™ê·¸ë¼ë¯¸ë¡œ ëŒ€ì²´
                    ctx.beginPath(); ctx.arc(0, 0, 16, 0, Math.PI * 2);
                    ctx.fillStyle = "#FFEB3B"; ctx.fill();
                    ctx.strokeStyle = "#FBC02D"; ctx.lineWidth = 3; ctx.stroke();
                }
                ctx.restore();
            }
            update() {
                if (isPaused) return;
                this.v += this.gravity;
                this.y += this.v;
                if (this.y + 15 > CH || this.y - 15 < 0) endGame();
            }
            jump() {
                if (isPaused || !gameActive) return;
                this.v = this.jumpPower;
                playSfx('jumpSound');
            }
        }

        function updateDifficulty() {
            if (score < 5) {
                pipeSpeed = 1.8; pipeGap = 180; spawnInterval = 120;
                levelTag.innerText = "ì´ˆë³´ ì‚ì•½ì´";
                levelTag.style.background = "#fff";
            } else if (score < 15) {
                pipeSpeed = 2.2 + (score - 5) * 0.1;
                pipeGap = 180 - (score - 5) * 3;
                spawnInterval = 110 - (score - 5) * 2;
                levelTag.innerText = "ì¤‘ìˆ˜ ì‚ì•½ì´";
                levelTag.style.background = "#ffeb3b";
            } else {
                pipeSpeed = Math.min(3.2 + (score - 15) * 0.05, 5.0);
                pipeGap = Math.max(150 - (score - 15) * 2, 110);
                spawnInterval = Math.max(90 - (score - 15) * 1, 65);
                levelTag.innerText = "ê³ ìˆ˜ ì‚ì•½ì´ ğŸ”¥";
                levelTag.style.background = "#ff8b94";
                levelTag.style.color = "white";
            }
            if (score >= 5) {
                const hue = Math.max(200 - score * 2, 150);
                canvas.style.background = `hsl(${hue}, 70%, 75%)`;
            }
        }

        function spawnPipe() {
            const minH = 60;
            const top = Math.random() * (CH - pipeGap - minH * 2) + minH;
            pipes.push({ x: CW, top: top, gap: pipeGap, passed: false });
        }

        function togglePause(e) {
            e.stopPropagation();
            if (!gameActive) return;
            isPaused = !isPaused;
            pauseBtn.innerText = isPaused ? "ê³„ì†" : "ì¤‘ì§€";
            if (!isPaused) requestAnimationFrame(loop);
        }

        function resetGame(e) {
            if(e) e.stopPropagation();
            bird = new Bird();
            pipes = []; score = 0; frames = 0;
            gameActive = true; isPaused = false;
            canvas.style.background = "var(--sky)";
            overlay.style.display = "none";
            document.getElementById("bestNotice").innerText = "";
            document.getElementById("score").innerText = "0";
            updateDifficulty();
            requestAnimationFrame(loop);
        }

        function endGame() {
            if (!gameActive) return;
            gameActive = false;
            playSfx('hitSound');
            let notice = "";
            if (score > highScore) {
                highScore = score;
                localStorage.setItem("piyakHighScore", highScore);
                bestEl.innerText = highScore;
                notice = "ğŸ‰ ì‹ ê¸°ë¡ ë‹¬ì„±! ğŸ‰";
            }
            document.getElementById("finalScore").innerText = `${score}ì  ë‹¬ì„±!`;
            document.getElementById("bestNotice").innerText = notice;
            overlay.style.display = "flex";
        }

        function loop() {
            if (!gameActive || isPaused) return;
            ctx.clearRect(0, 0, CW, CH);
            updateDifficulty();

            if (frames % Math.floor(spawnInterval) === 0) spawnPipe();
            
            pipes.forEach((p, i) => {
                p.x -= pipeSpeed;
                ctx.fillStyle = "#8BC34A";
                ctx.fillRect(p.x, 0, 50, p.top);
                ctx.fillRect(p.x, p.top + p.gap, 50, CH);
                ctx.strokeStyle = "#558B2F"; ctx.lineWidth = 2;
                ctx.strokeRect(p.x, 0, 50, p.top);
                ctx.strokeRect(p.x, p.top + p.gap, 50, CH);
                
                if (bird.x + 15 > p.x && bird.x - 15 < p.x + 50) {
                    if (bird.y - 15 < p.top || bird.y + 15 > p.top + p.gap) endGame();
                }
                if (p.x + 50 < bird.x && !p.passed) {
                    score++; p.passed = true;
                    document.getElementById("score").innerText = score;
                    playSfx('scoreSound');
                }
                if (p.x < -50) pipes.splice(i, 1);
            });

            bird.update();
            bird.draw();
            frames++;
            requestAnimationFrame(loop);
        }

        window.addEventListener("touchstart", (e) => {
            if(e.target.tagName === 'BUTTON') return;
            e.preventDefault(); bird.jump();
        }, { passive: false });
        window.addEventListener("mousedown", (e) => {
            if(e.target.tagName === 'BUTTON') return;
            bird.jump();
        });
        window.addEventListener("keydown", (e) => { if (e.code === "Space") bird.jump(); });
    </script>
</body>
</html>
